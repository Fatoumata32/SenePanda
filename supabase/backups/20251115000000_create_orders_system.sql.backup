-- ================================================
-- SYSTÈME DE COMMANDES (ORDERS)
-- ================================================
-- Cette migration crée les tables de commandes et étend le système de panier existant
-- La table cart_items existe déjà dans 20251011232345_create_marketplace_schema.sql

-- Table: orders (Commandes)
CREATE TABLE IF NOT EXISTS orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- Montant et devise
  total_amount DECIMAL(10, 2) NOT NULL CHECK (total_amount >= 0),
  currency VARCHAR(3) DEFAULT 'XOF',

  -- Statut de la commande
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'refunded')),

  -- Informations de livraison
  shipping_name VARCHAR(255) NOT NULL,
  shipping_phone VARCHAR(50),
  shipping_address TEXT NOT NULL,
  shipping_city VARCHAR(100),
  shipping_postal_code VARCHAR(20),
  shipping_country VARCHAR(100),

  -- Notes et informations supplémentaires
  order_notes TEXT,
  tracking_number VARCHAR(100),

  -- Informations de paiement
  payment_method VARCHAR(50),
  payment_status VARCHAR(20) DEFAULT 'pending' CHECK (payment_status IN ('pending', 'paid', 'failed', 'refunded')),

  -- Points utilisés pour cette commande
  points_used INTEGER DEFAULT 0,
  discount_amount DECIMAL(10, 2) DEFAULT 0,

  -- Dates importantes
  confirmed_at TIMESTAMPTZ,
  shipped_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: order_items (Articles de commande)
CREATE TABLE IF NOT EXISTS order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE SET NULL,
  seller_id UUID REFERENCES profiles(id) ON DELETE SET NULL,

  -- Informations du produit au moment de la commande (snapshot)
  product_title VARCHAR(255) NOT NULL,
  product_image_url TEXT,

  -- Prix et quantité
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  unit_price DECIMAL(10, 2) NOT NULL CHECK (unit_price >= 0),
  total_price DECIMAL(10, 2) NOT NULL CHECK (total_price >= 0),

  -- Commission du vendeur
  seller_commission DECIMAL(10, 2),
  platform_fee DECIMAL(10, 2),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ================================================
-- INDEX POUR PERFORMANCES
-- ================================================

-- Index pour cart_items (si non existants)
CREATE INDEX IF NOT EXISTS idx_cart_items_user_id ON cart_items(user_id);
CREATE INDEX IF NOT EXISTS idx_cart_items_product_id ON cart_items(product_id);

-- Index pour orders
CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at DESC);

-- Index pour order_items
CREATE INDEX IF NOT EXISTS idx_order_items_order_id ON order_items(order_id);
CREATE INDEX IF NOT EXISTS idx_order_items_product_id ON order_items(product_id);
CREATE INDEX IF NOT EXISTS idx_order_items_seller_id ON order_items(seller_id);

-- ================================================
-- TRIGGERS POUR updated_at
-- ================================================

-- Fonction update_updated_at déjà créée dans les migrations précédentes
-- On ne la recrée pas avec CREATE OR REPLACE pour éviter les conflits

-- Trigger pour cart_items (si non existant)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_trigger WHERE tgname = 'update_cart_items_updated_at'
  ) THEN
    CREATE TRIGGER update_cart_items_updated_at
      BEFORE UPDATE ON cart_items
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
  END IF;
END
$$;

-- Trigger pour orders
CREATE TRIGGER update_orders_updated_at
  BEFORE UPDATE ON orders
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ================================================
-- ROW LEVEL SECURITY (RLS)
-- ================================================

ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

-- Politiques pour orders
CREATE POLICY "Users can view their own orders"
  ON orders FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own orders"
  ON orders FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own orders"
  ON orders FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Politiques pour order_items
CREATE POLICY "Users can view order items of their orders"
  ON order_items FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM orders
      WHERE orders.id = order_items.order_id
      AND orders.user_id = auth.uid()
    )
  );

CREATE POLICY "Sellers can view their order items"
  ON order_items FOR SELECT
  USING (seller_id = auth.uid());

-- ================================================
-- FONCTIONS UTILITAIRES
-- ================================================

-- Fonction pour obtenir le total du panier
CREATE OR REPLACE FUNCTION get_cart_total(p_user_id UUID)
RETURNS TABLE (
  total_items BIGINT,
  total_amount DECIMAL(10, 2)
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::BIGINT as total_items,
    COALESCE(SUM(ci.quantity * p.price), 0)::DECIMAL(10, 2) as total_amount
  FROM cart_items ci
  JOIN products p ON p.id = ci.product_id
  WHERE ci.user_id = p_user_id AND p.is_active = true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fonction pour vider le panier après une commande
CREATE OR REPLACE FUNCTION clear_cart(p_user_id UUID)
RETURNS void AS $$
BEGIN
  DELETE FROM cart_items WHERE user_id = p_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fonction pour créer une commande à partir du panier
CREATE OR REPLACE FUNCTION create_order_from_cart(
  p_user_id UUID,
  p_shipping_name VARCHAR(255),
  p_shipping_phone VARCHAR(50),
  p_shipping_address TEXT,
  p_shipping_city VARCHAR(100),
  p_shipping_postal_code VARCHAR(20),
  p_shipping_country VARCHAR(100),
  p_order_notes TEXT DEFAULT NULL,
  p_payment_method VARCHAR(50) DEFAULT 'cash_on_delivery'
)
RETURNS UUID AS $$
DECLARE
  v_order_id UUID;
  v_total_amount DECIMAL(10, 2);
  v_cart_item RECORD;
BEGIN
  -- Vérifier que le panier n'est pas vide
  IF NOT EXISTS (SELECT 1 FROM cart_items WHERE user_id = p_user_id) THEN
    RAISE EXCEPTION 'Cart is empty';
  END IF;

  -- Calculer le montant total
  SELECT COALESCE(SUM(ci.quantity * p.price), 0)
  INTO v_total_amount
  FROM cart_items ci
  JOIN products p ON p.id = ci.product_id
  WHERE ci.user_id = p_user_id AND p.is_active = true;

  -- Créer la commande
  INSERT INTO orders (
    user_id,
    total_amount,
    currency,
    status,
    shipping_name,
    shipping_phone,
    shipping_address,
    shipping_city,
    shipping_postal_code,
    shipping_country,
    order_notes,
    payment_method,
    payment_status
  ) VALUES (
    p_user_id,
    v_total_amount,
    'XOF',
    'pending',
    p_shipping_name,
    p_shipping_phone,
    p_shipping_address,
    p_shipping_city,
    p_shipping_postal_code,
    p_shipping_country,
    p_order_notes,
    p_payment_method,
    'pending'
  ) RETURNING id INTO v_order_id;

  -- Créer les order_items à partir du panier
  FOR v_cart_item IN
    SELECT
      ci.*,
      p.title,
      p.image_url,
      p.price,
      p.seller_id
    FROM cart_items ci
    JOIN products p ON p.id = ci.product_id
    WHERE ci.user_id = p_user_id AND p.is_active = true
  LOOP
    INSERT INTO order_items (
      order_id,
      product_id,
      seller_id,
      product_title,
      product_image_url,
      quantity,
      unit_price,
      total_price
    ) VALUES (
      v_order_id,
      v_cart_item.product_id,
      v_cart_item.seller_id,
      v_cart_item.title,
      v_cart_item.image_url,
      v_cart_item.quantity,
      v_cart_item.price,
      v_cart_item.quantity * v_cart_item.price
    );

    -- Décrémenter le stock du produit
    UPDATE products
    SET stock = stock - v_cart_item.quantity
    WHERE id = v_cart_item.product_id;
  END LOOP;

  -- Vider le panier
  PERFORM clear_cart(p_user_id);

  RETURN v_order_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ================================================
-- COMMENTAIRES
-- ================================================

COMMENT ON TABLE orders IS 'Commandes des utilisateurs';
COMMENT ON TABLE order_items IS 'Articles individuels dans chaque commande';
COMMENT ON FUNCTION get_cart_total IS 'Obtenir le nombre d''articles et le montant total du panier';
COMMENT ON FUNCTION clear_cart IS 'Vider le panier d''un utilisateur';
COMMENT ON FUNCTION create_order_from_cart IS 'Créer une commande à partir du contenu du panier';
